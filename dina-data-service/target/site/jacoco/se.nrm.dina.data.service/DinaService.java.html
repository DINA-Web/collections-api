<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DinaService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dina-data-service</a> &gt; <a href="index.source.html" class="el_package">se.nrm.dina.data.service</a> &gt; <span class="el_source">DinaService.java</span></div><h1>DinaService.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package se.nrm.dina.data.service;
    
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;   
import javax.ejb.EJB; 
import javax.ejb.Stateless; 
import javax.servlet.http.HttpServletRequest;  
import javax.ws.rs.Consumes;
import javax.ws.rs.DELETE;
import javax.ws.rs.DefaultValue;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces; 
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.HttpHeaders;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.MultivaluedMap;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.UriInfo;
import org.apache.commons.lang.StringUtils;  
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import se.nrm.dina.data.exceptions.DinaConstraintViolationException;
import se.nrm.dina.data.exceptions.DinaException;  
import se.nrm.dina.logic.DinaDataLogic;
 
/**
 *
 * @author idali
 */
@Path(&quot;/v0&quot;)
@Consumes({MediaType.APPLICATION_JSON+&quot;;charset=UTF-8&quot;})
@Produces({MediaType.APPLICATION_JSON + &quot;;charset=UTF-8&quot;})
@Stateless
public class DinaService {

<span class="fc" id="L47">    private final Logger logger = LoggerFactory.getLogger(this.getClass());</span>

    @EJB
    private DinaDataLogic logic;
 

<span class="fc" id="L53">    public DinaService() {</span>

<span class="fc" id="L55">    }</span>
    
<span class="fc" id="L57">    public DinaService(DinaDataLogic logic) {</span>
<span class="fc" id="L58">        this.logic = logic;</span>
<span class="fc" id="L59">    }</span>
    
    @GET
    @Path(&quot;{entity}&quot;) 
    public Response getAllByEntityName (@PathParam(&quot;entity&quot;) String entity, 
                                        @QueryParam(&quot;offset&quot;) int offset, 
                                        @DefaultValue(&quot;50&quot;) @QueryParam(&quot;limit&quot;) int limit, 
                                        @DefaultValue(&quot;0&quot;) @QueryParam(&quot;minid&quot;) int minid,
                                        @DefaultValue(&quot;0&quot;) @QueryParam(&quot;maxid&quot;) int maxid,
                                        @DefaultValue(&quot;asc&quot;) @QueryParam(&quot;sort&quot;) String sort,
                                        @QueryParam(&quot;orderby&quot;) String orderby) {
        
<span class="fc" id="L71">        logger.info(&quot;getAllByEntityName : {} -- {}&quot;, entity, offset + &quot; -- &quot; + limit);    </span>
        
<span class="fc" id="L73">        List&lt;String&gt; order = new ArrayList();</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if(orderby != null) {</span>
<span class="fc" id="L75">            order = Arrays.asList(StringUtils.split(orderby, &quot;,&quot;));</span>
        }
      
        try {   
<span class="fc" id="L79">            return Response.ok(logic.findAll(entity, offset, limit, minid, maxid, sort, order, null)).build();</span>
<span class="fc" id="L80">        } catch(DinaException e) {</span>
<span class="fc" id="L81">            return Response.status(e.getErrorCode()) </span>
<span class="fc" id="L82">                    .entity(e.getMessage()).build();</span>
        }   
    }
     
    @GET
    @Path(&quot;{entity}/search&quot;)  
    public Response getData(@PathParam(&quot;entity&quot;) String entity, @Context UriInfo info) {

<span class="fc" id="L90">        MultivaluedMap&lt;String, String&gt; map = info.getQueryParameters(); </span>

        try {  
<span class="fc" id="L93">            return Response.ok(logic.findAllBySearchCriteria(entity, map)).build();  </span>
<span class="fc" id="L94">        } catch(DinaException e) {</span>
<span class="fc" id="L95">            return Response.status(e.getErrorCode()) </span>
<span class="fc" id="L96">                    .entity(e.getMessage()).build();</span>
        }  
    } 
        
    /**
     * Generic method to get an entity by entity id from database.  
     * This method passes in a PathParam entity class name and entity id 
     * 
     * @param headers
     * @param httpServletRequest
     * @param entity - class name of the entity
     * @param id - entity id
     * 
     * @return entity 
     */
    @GET
    @Path(&quot;{entity}/{id}/&quot;) 
    public Response getEntityById(@Context HttpHeaders headers,
                                  @Context HttpServletRequest httpServletRequest,
                                  @PathParam(&quot;entity&quot;) String entity, @PathParam(&quot;id&quot;) String id) {
        
<span class="nc" id="L117">        logger.info(&quot;getEntityById - entity: {}, id :  {}&quot;, entity, id);</span>
        
//        
//        KeycloakSecurityContext securityContext = (KeycloakSecurityContext) httpServletRequest
//                                                        .getAttribute(KeycloakSecurityContext.class.getName());
//        
//        AccessToken accessToken = securityContext.getToken();
//        logger.info(&quot;accesstoken : {}&quot;, accessToken);
//         
//        logger.info(&quot;acc token : {} -- {}&quot;, accessToken.getIssuer(), accessToken.getId());
//       
//        logger.info(&quot;acc token : {} -- {}&quot;, accessToken.getGivenName(), accessToken.getEmail());
//        
//        Set&lt;String&gt; set = accessToken.getRealmAccess().getRoles();
//        
//        logger.info(&quot;set : {} -- {}&quot;, set, accessToken.issuedFor);
//         
//        String tokenId = headers.getHeaderString(&quot;id_token&quot;);
//        logger.info(tokenId);
//        
//
////        logger.info(&quot;header : {}&quot;, headers.getRequestHeaders());
//        Principal userPrincipal = httpServletRequest.getUserPrincipal();
//        logger.info(&quot;user principal : {} -- {}&quot;, userPrincipal, userPrincipal.getName());
//    
//        if (userPrincipal instanceof KeycloakPrincipal) {
//
//            KeycloakPrincipal&lt;KeycloakSecurityContext&gt; kp = (KeycloakPrincipal&lt;KeycloakSecurityContext&gt;) userPrincipal;
//            IDToken token = kp.getKeycloakSecurityContext().getIdToken();
//            logger.info(&quot;token id : {}&quot;, token); 
//
//        } else {
//            throw new RuntimeException();
//        }
// 
   
         
        
        
        
        
        
        
        
        
         
        try {     
<span class="nc" id="L164">            return Response.ok(logic.findById(id, entity)).build(); </span>
<span class="nc" id="L165">        } catch (DinaException e) {</span>
<span class="nc" id="L166">            return Response.status(e.getErrorCode()) </span>
<span class="nc" id="L167">                    .entity(e.getMessage()).build();</span>
        }
    }
    
    
   
        
 

//    private static IDToken getIDToken(HttpServletRequest req) {
//        System.out.println(&quot;getIDToken&quot;);
//        KeycloakSecurityContext session = (KeycloakSecurityContext) req.getAttribute(KeycloakSecurityContext.class.getName());
//        System.out.println(&quot;token : &quot; + session.getTokenString());
//        return session.getIdToken();
//
//    }

    /**
     * Generic method to get an entity by entity id from database. This method
     * passes in a PathParam entity class name and entity id
     *
     * @param entity - class name of the entity
     * @param ids
     * 
     * @return entity 
     */
    @GET
    @Path(&quot;{entity}/search/{ids}/&quot;) 
    public Response getEntityByIds(@PathParam(&quot;entity&quot;) String entity, @PathParam(&quot;ids&quot;) String ids) {
        
<span class="nc" id="L197">        logger.info(&quot;getEntityByIds - entity: {}, id :  {}&quot;, entity, ids);</span>
   
        try {      
<span class="nc" id="L200">            return Response.ok(logic.findEntitiesByids(entity, ids)).build(); </span>
<span class="nc" id="L201">        } catch (DinaException e) {</span>
<span class="nc" id="L202">            return Response.status(e.getErrorCode()) </span>
<span class="nc" id="L203">                    .entity(e.getMessage()).build();</span>
        }
    }
    
    
    @GET
    @Path(&quot;{entity}/{field}&quot;) 
    public Response getEntitiesBySearchQuery(@PathParam(&quot;entity&quot;) String entity, @PathParam(&quot;field&quot;) String field, @Context UriInfo info) {
<span class="nc" id="L211">        logger.info(&quot;getEntitiesBySearchQuery - entity: {}, field :  {}&quot;, entity, field);</span>
        
<span class="nc" id="L213">        MultivaluedMap&lt;String, String&gt; map = info.getQueryParameters();</span>
<span class="nc" id="L214">        logic.findBysearchQuery(entity, field, map);</span>
        
<span class="nc" id="L216">        return Response.ok().build();</span>
    }


    /**
     * Generic method to get an entity by entity id from database.  
     * This method passes in a PathParam entity class name and entity id 
     * 
     * @param entity - class name of the entity 
     * 
     * @return entity 
     */
    @GET
    @Path(&quot;{entity}/count&quot;)  
    public Response getEntityCount(@PathParam(&quot;entity&quot;) String entity ) {
        
<span class="fc" id="L232">        logger.info(&quot;getEntityById - entity: {} &quot;, entity );</span>

        try {  
<span class="fc" id="L235">            int count = logic.findEntityCount(entity); </span>
              
<span class="fc" id="L237">            return Response.ok(String.valueOf(count)).build(); </span>
<span class="fc" id="L238">        } catch(DinaException e) { </span>
<span class="fc" id="L239">            return Response.status(e.getErrorCode()) </span>
<span class="fc" id="L240">                    .entity(e.getMessage()).build();</span>
        }  
    } 

    /**
     * Generic method to create an entity by passing SpecifyBeanWrapper, the
     * entity to be created is wrapped into SpecifyBeanWrapper
     *
     * @param entity
     * @param json 
     * @return  Response
     *
     */
    @POST
    @Path(&quot;{entity}&quot;)
    @Consumes(&quot;application/json&quot;)
    public Response createNewEntity(@PathParam(&quot;entity&quot;) String entity, String json) {
<span class="fc" id="L257">        logger.info(&quot;createNewEntity - entity: {}&quot;, json);</span>
 
        try {  
<span class="fc" id="L260">            return Response.ok(logic.createEntity(entity, json)).build();</span>
<span class="nc" id="L261">         } catch(DinaConstraintViolationException e) {   </span>
<span class="nc" id="L262">            return Response.status(e.getErrorCode()) </span>
<span class="nc" id="L263">                    .entity(e.getErrorBeans()).build();</span>
        }  
    }

    /**
     * Generic method update an entity
     * 
     * @param entity
     * @param json 
     *
     * @return
     *
     */
    @PUT
    @Path(&quot;{entity}&quot;) 
    public Response updateEntity(@PathParam(&quot;entity&quot;) String entity, String json) {
    
<span class="fc" id="L280">        logger.info(&quot;update entity: {} -- {}&quot;, entity, json);</span>
        
         try {  
<span class="fc" id="L283">            return Response.ok(logic.updateEntity(entity, json)).build(); </span>
<span class="fc" id="L284">         } catch(DinaException e) { </span>
<span class="fc" id="L285">            return Response.status(e.getErrorCode()) </span>
<span class="fc" id="L286">                    .entity(e.getMessage()).build();</span>
        }  
    }
      
    /**
     * Generic method to delete an entity by entity id from database.  
     * This method passes in a PathParam entity class name and entity id 
     * 
     * @param entity - class name of the entity 
     * @param id 
     * 
     * @return entity 
     */
    @DELETE
    @Path(&quot;{entity}/{id}&quot;)  
    public Response deleteEntityById(@PathParam(&quot;entity&quot;) String entity, @PathParam(&quot;id&quot;) int id) {
        
<span class="fc" id="L303">        logger.info(&quot;deleteEntityById - entity -- id: {} -- {}&quot;, entity, id );</span>

        try {   
<span class="fc" id="L306">            logic.deleteEntity(entity, id);  </span>
<span class="fc" id="L307">            return Response.ok().build();  </span>
<span class="fc" id="L308">        } catch(DinaException e) { </span>
<span class="fc" id="L309">            logger.error(&quot;not ok&quot;);</span>
<span class="fc" id="L310">            return Response.status(e.getErrorCode()) </span>
<span class="fc" id="L311">                    .entity(e.getMessage()).build();</span>
        }  
    } 
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>