<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DinaDataLogic.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dina-data-jpa</a> &gt; <a href="index.source.html" class="el_package">se.nrm.dina.data.logic</a> &gt; <span class="el_source">DinaDataLogic.java</span></div><h1>DinaDataLogic.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package se.nrm.dina.data.logic;
 
//import com.fasterxml.jackson.databind.ObjectMapper; 
import java.io.IOException;
import java.io.Serializable; 
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.function.Predicate;  
import java.util.stream.Collectors;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.ws.rs.core.MultivaluedMap;
import org.codehaus.jackson.map.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import se.nrm.dina.data.exceptions.DinaException;
import se.nrm.dina.data.jpa.DinaDao;
import se.nrm.dina.data.util.NamedQueries;
import se.nrm.dina.data.util.Util; 
import se.nrm.dina.datamodel.EntityBean;
//import se.nrm.specify.datamodel.SpecifyBean;

/**
 *
 * @author idali
 * @param &lt;T&gt;
 */
@Stateless
public class DinaDataLogic&lt;T extends EntityBean&gt; implements Serializable {

<span class="fc" id="L39">    private final Logger logger = LoggerFactory.getLogger(this.getClass());</span>

    @EJB
    private DinaDao dao;

<span class="fc" id="L44">    public DinaDataLogic() {</span>

<span class="fc" id="L46">    }</span>
    
<span class="fc" id="L48">    public DinaDataLogic(DinaDao dao) {</span>
<span class="fc" id="L49">        this.dao = dao;</span>
<span class="fc" id="L50">    }</span>

    /**
     * Finds all the instances of an entity
     * @param entityName
     * @return List&lt;T&gt; 
     */
    public List&lt;T&gt; findAll(String entityName) { 
        try {
<span class="fc" id="L59">            return dao.findAll(Util.getInstance().convertClassNameToClass(entityName));</span>
<span class="fc" id="L60">        } catch (DinaException e) {</span>
<span class="fc" id="L61">            throw new DinaException(e.getMessage());</span>
        }
    }

    /**
     * Finds all the instances of an entity
     * @param entityName
     * @param offset
     * @param limit
     * @param minid
     * @param maxid
     * @param sort
     * @param conditions
     * @return List&lt;T&gt;
     */
    public List&lt;T&gt; findAll(String entityName, int offset, int limit,
            int minid, int maxid, List&lt;String&gt; sort, Map&lt;String, String&gt; conditions) {
 
<span class="fc" id="L79">        entityName = Util.getInstance().validateEntityName(entityName);</span>
<span class="fc" id="L80">        Class clazz = Util.getInstance().convertClassNameToClass(entityName);</span>
        try {
<span class="fc" id="L82">            String strQuery = NamedQueries.getInstance()</span>
<span class="fc" id="L83">                    .createQueryFindAllWithSearchCriteria(entityName, clazz, offset, minid, maxid, sort, true, conditions);</span>

<span class="fc" id="L85">            List&lt;T&gt; results = dao.findAll(clazz, strQuery, limit, conditions);</span>
 
<span class="fc" id="L87">            return results;</span>
<span class="fc" id="L88">        } catch (DinaException e) {</span>
<span class="fc" id="L89">            throw new DinaException(e.getMessage());</span>
        }
    }

    /**
     * Finds all the instances of an entity by query
     * @param entityName
     * @param map
     * @return List
     */
    public List&lt;T&gt; findAllBySearchCriteria(String entityName, MultivaluedMap&lt;String, String&gt; map) {

<span class="fc" id="L101">        logger.info(&quot;findAllBySearchCriteria : {}&quot;, map);</span>

<span class="fc" id="L103">        entityName = Util.getInstance().validateEntityName(entityName);</span>

<span class="fc" id="L105">        String offset = map.getFirst(&quot;offset&quot;);</span>
<span class="fc" id="L106">        String limit = map.getFirst(&quot;limit&quot;);</span>
<span class="fc" id="L107">        String minid = map.getFirst(&quot;minid&quot;);</span>
<span class="fc" id="L108">        String maxid = map.getFirst(&quot;maxid&quot;);</span>
<span class="fc" id="L109">        String orderBy = map.getFirst(&quot;orderby&quot;);</span>
<span class="fc" id="L110">        String exact = map.getFirst(&quot;exact&quot;);</span>
        
<span class="fc bfc" id="L112" title="All 2 branches covered.">        boolean isExact = exact == null ? false : Boolean.valueOf(exact);</span>
        

<span class="fc" id="L115">        List&lt;String&gt; orderby = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (orderBy != null) {</span>
<span class="fc" id="L117">            orderby = Arrays.asList(orderBy.split(&quot;,&quot;));</span>
        }
          
<span class="fc" id="L120">        Map&lt;String, String&gt; condition = map.entrySet()</span>
<span class="fc" id="L121">                .stream()</span>
<span class="fc" id="L122">                .filter(filterCondition()) </span>
<span class="pc" id="L123">                .collect(Collectors.toMap(m -&gt; m.getKey(), m -&gt; m.getValue().get(0)));</span>
  
        try {
<span class="fc" id="L126">            Class clazz = Util.getInstance().convertClassNameToClass(entityName);</span>
<span class="fc" id="L127">            Util.getInstance().isFieldsValid(clazz, condition);</span>

<span class="fc bfc" id="L129" title="All 2 branches covered.">            String strQuery = NamedQueries.getInstance()</span>
<span class="fc" id="L130">                    .createQueryFindAllWithSearchCriteria(</span>
                            entityName,
                            clazz,
<span class="fc bfc" id="L133" title="All 2 branches covered.">                            Integer.parseInt(offset == null ? &quot;0&quot; : offset),</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">                            Integer.parseInt(minid == null ? &quot;0&quot; : minid),</span>
<span class="fc" id="L135">                            Integer.parseInt(maxid == null ? &quot;0&quot; : maxid),</span>
                            orderby, isExact, condition);
            
<span class="fc" id="L138">            logger.info(&quot;strQuery : {}&quot;, strQuery);</span>
<span class="fc bfc" id="L139" title="All 6 branches covered.">            return isExact ? dao.findAll(clazz, strQuery, Integer.parseInt(limit == null ? &quot;50&quot; : limit), condition) : </span>
<span class="fc" id="L140">                             dao.findAllWithFuzzSearch(clazz, strQuery, Integer.parseInt(limit == null ? &quot;50&quot; : limit), condition); </span>
<span class="fc" id="L141">        } catch (DinaException e) {</span>
<span class="fc" id="L142">            throw new DinaException(&quot;Error.  &quot; + e.getMessage() + &quot; is not valid field in &quot; + entityName);</span>
        }
    }
 
    private Predicate&lt;Entry&lt;String, List&lt;String&gt;&gt;&gt; filterCondition() {
<span class="fc bfc" id="L147" title="All 2 branches covered.">        return s -&gt; !s.getKey().equals(&quot;offset&quot;)</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">                    &amp;&amp; !s.getKey().equals(&quot;limit&quot;)</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">                    &amp;&amp; !s.getKey().equals(&quot;minid&quot;)</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">                    &amp;&amp; !s.getKey().equals(&quot;maxid&quot;)</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">                    &amp;&amp; !s.getKey().equals(&quot;orderby&quot;)</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">                    &amp;&amp; !s.getKey().equals(&quot;exact&quot;);</span>
    }

    /**
     * Finds an entity by its database id
     * @param id
     * @param entityName
     * @return T
     */
    public T findById(String id, String entityName) {
<span class="fc" id="L162">        logger.info(&quot;findById : {} --Â {}&quot;, id, entityName);</span>

        try {
<span class="fc bfc" id="L165" title="All 2 branches covered.">            if (Util.getInstance().isNumric(id)) {</span>
<span class="fc" id="L166">                return (T) dao.findById(Integer.parseInt(id), Util.getInstance().convertClassNameToClass(entityName));</span>
            } else {
<span class="fc" id="L168">                return (T) dao.findByStringId(id, Util.getInstance().convertClassNameToClass(entityName));</span>
            } 
<span class="fc" id="L170">        } catch (DinaException e) {</span>
<span class="fc" id="L171">            throw new DinaException(e.getMessage());</span>
        }
    }

    /**
     * Finds the total number of an entity in database
     * @param entityName
     * @return int
     */
    public int findEntityCount(String entityName) {

        try {
<span class="fc" id="L183">            return dao.getCountByQuery(NamedQueries.getInstance().createFindTotalCountNamedQuery(Util.getInstance().convertClassNameToClass(entityName).getSimpleName()));</span>
<span class="fc" id="L184">        } catch (DinaException e) {</span>
<span class="fc" id="L185">            throw new DinaException(e.getMessage());</span>
        }
    }

    /**
     * Creates an entity in database
     * @param entityName
     * @param json
     * @return EntityBean
     */
    public EntityBean createEntity(String entityName, String json) {

<span class="fc" id="L197">        logger.info(&quot;createEntity : {} &quot;, entityName);</span>
 
        try {
<span class="fc" id="L200">            EntityBean bean = mappObject(entityName, json);</span>
<span class="fc" id="L201">            return dao.create(bean);</span>
<span class="fc" id="L202">        } catch (DinaException ex) {</span>
<span class="fc" id="L203">            throw new DinaException(ex.getMessage());</span>
        }

    }

    /**
     * Updates an entity in database
     * @param entityName
     * @param json
     * @return EntityBean
     */
    public EntityBean updateEntity(String entityName, String json) {
<span class="fc" id="L215">        logger.info(&quot;updateEntity : {} -- {}&quot;, entityName, json);</span>

        try {
<span class="fc" id="L218">            EntityBean bean = mappObject(entityName, json);</span>
<span class="fc" id="L219">            return dao.merge(bean); </span>
<span class="fc" id="L220">        } catch (DinaException ex) {</span>
<span class="fc" id="L221">            throw new DinaException(ex.getMessage());</span>
        }
    }

 
    private EntityBean mappObject(String entityName, String json) {

<span class="fc" id="L228">        ObjectMapper mapper = new ObjectMapper();</span>

<span class="fc" id="L230">        EntityBean bean = null;</span>
        try {
<span class="fc" id="L232">            bean = (EntityBean) mapper.readValue(json, Util.getInstance().convertClassNameToClass(entityName));</span>
<span class="nc" id="L233">        } catch (IOException ex) {</span>
<span class="nc" id="L234">            throw new DinaException(ex.getMessage());</span>
<span class="fc" id="L235">        }</span>
<span class="fc" id="L236">        return bean;</span>
    }
  
    /**
     * Deletes an entity in database
     * @param entityName
     * @param id 
     */
    public void deleteEntity(String entityName, int id) {

<span class="fc" id="L246">        logger.info(&quot;deleteEntity : {} -- {}&quot;, entityName, id);</span>

        try { 
<span class="fc" id="L249">            EntityBean bean = dao.findByReference(id, Util.getInstance().convertClassNameToClass(entityName));</span>
         
<span class="fc bfc" id="L251" title="All 2 branches covered.">            if (bean != null) { </span>
<span class="fc" id="L252">                dao.delete(bean);</span>
            }
<span class="fc" id="L254">        } catch (DinaException e) {</span>
<span class="fc" id="L255">            logger.error(e.getMessage());</span>
<span class="fc" id="L256">            throw new DinaException(e.getMessage());</span>
<span class="fc" id="L257">        }</span>
<span class="fc" id="L258">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>